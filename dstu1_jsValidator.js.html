<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: dstu1/jsValidator.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: dstu1/jsValidator.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @class JsValidator
 * @memberof module:dstu1
 * @param profiles
 */
module.exports = function(profiles) {
    var self = this;
    var result;
    var elements;

    var findProfileByResourceType = function(resourceType) {
        for (var i in profiles) {
            var profile = profiles[i];

            if (profile.name == resourceType.toLowerCase()) {
                return profile;
            }
        }
    };

    var findProfileById = function(profileId) {
        for (var i in profiles) {
            var profile = profiles[i];

            if (profile.identifier == profileId) {
                return profile;
            }
        }
    };

    var validateCardinality = function(element, obj, currentPath) {
        var pathSplit = element.path.replace(currentPath + '.', '').split('.');
        var current = [ obj ];

        for (var i in pathSplit) {
            var next = [];

            for (var x in current) {
                var currentEval = eval('current[x][\'' + pathSplit[i] + '\']');

                if (currentEval) {
                    if (currentEval instanceof Array) {
                        next = next.concat(currentEval);
                    } else if (currentEval || currentEval == false) {
                        next.push(currentEval);
                    }
                }
            }

            current = next;
        }

        if (current.length &lt; element.definition.min) {
            result.errors.push('Element ' + element.path + ' does not meet the minimal cardinality of ' + element.definition.min + ' (actual: ' + current.length + ')');
        }

        if (current.length > (element.definition.max == '*' ? Number.MAX_SAFE_INTEGER : parseInt(element.definition.max))) {
            result.errors.push('Element ' + element.path + ' does not meet the maximum cardinality of ' + element.definition.max + ' (actual: ' + current.length + ')');
        }

        if (current.length > 0) {
            if (element.definition.type &amp;&amp; element.definition.type.length == 1 &amp;&amp; element.definition.type[0].code == 'Resource') {
                // Validate child profiles
                for (var i in current) {
                    var nextObj = current[i];
                    var childProfile = findProfileByResourceType(nextObj.resourceType);

                    if (childProfile) {
                        var childValidator = new module.exports(profiles);
                        var childResults = childValidator.Validate(nextObj, childProfile);

                        if (!childResults.valid) {
                            for (var x in childResults.errors) {
                                var childError = childResults.errors[x];

                                if (element.path == 'Bundle.entry.content') {
                                    result.errors.push(element.path + ' "' + obj.title + '": ' + childError);
                                } else {
                                    result.errors.push(element.path + ': ' + childError);
                                }
                            }
                        }
                    }
                }
            } else {
                // Validate cardinality
                for (var i in elements) {
                    var nextElement = elements[i];

                    if (nextElement.path.indexOf(element.path) == 0 &amp;&amp; nextElement.path.split('.').length == (currentPath.split('.').length + pathSplit.length) + 1) {
                        for (var x in current) {
                            var nextObj = current[x];

                            validateCardinality(nextElement, nextObj, element.path);
                        }
                    }
                }
            }
        }
    };

    self.Validate = function(jsObj, profile) {
        if (!profile) {
            profile = findProfileByResourceType(jsObj.resourceType);
        }

        elements = profile &amp;&amp; profile.structure &amp;&amp; profile.structure.length > 0 ? profile.structure[0].element : null;
        result = {
            valid: true,
            errors: []
        };

        if (!profile) {
            throw 'No profile found for resource: ' + jsObj.resourceType;
        }

        if (!elements) {
            throw 'No structure/elements found for profile ' + profile.name;
        }

        for (var i in elements) {
            var element = elements[i];

            if (element.path == jsObj.resourceType || !element.definition || !element.path) {
                continue;
            }

            // Only call validateCardinality on the first property of the resource. validateCardinality
            // will be recursively called there-after.
            if (element.path.split('.').length == 2) {
                validateCardinality(element, jsObj, jsObj.resourceType);
            }
        }

        result.valid = result.errors.length == 0;
        return result;
    };
};</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-dstu1.html">dstu1</a></li><li><a href="module-dstu2.html">dstu2</a></li><li><a href="module-stu3.html">stu3</a></li></ul><h3>Classes</h3><ul><li><a href="Fhir.html">Fhir</a></li><li><a href="module-dstu1.JsParser.html">JsParser</a></li><li><a href="module-dstu1.JsValidator.html">JsValidator</a></li><li><a href="module-dstu1.XmlParser.html">XmlParser</a></li><li><a href="module-dstu2.JsParser.html">JsParser</a></li><li><a href="module-dstu2.JsValidator.html">JsValidator</a></li><li><a href="module-dstu2.XmlParser.html">XmlParser</a></li><li><a href="module-stu3.JsParser.html">JsParser</a></li><li><a href="module-stu3.JsValidator.html">JsValidator</a></li><li><a href="module-stu3.XmlParser.html">XmlParser</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.3</a> on Wed Jan 18 2017 09:39:39 GMT-0800 (Pacific Standard Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
